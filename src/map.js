
angular.module('app', [])
    .service('MapService', function () {
        const map = L.map('mapid').setView([3.2269, 115.4622], 12);

        L.tileLayer('https://c.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            id: 'openstreetmap',
        }).addTo(map);

        let geotiffLayer;
        const displayMin = 1
        const displayMax = 5
        const normalize = function(val) { return (val - displayMin) / (displayMax - displayMin); }

        const colours = ["#2b83ba", "#2b4Dba", "#0000ff", "#000072", "#000000"]
        const labels = [10, 100, 200, 1000, 10000]
        plotty.addColorScale("return-periods", colours,
            [1, 2, 3, 4, 5].map(normalize));

        const legend = L.control({position: 'topleft'});

        legend.onAdd = function (map) {

            let div = L.DomUtil.create('div', 'info legend')
            div.innerHTML += '<h5>Return Period (yrs)</h5>'

            // loop through our density intervals and generate a label with a colored square for each interval
            for (let i = 0; i < labels.length; i++) {
                div.innerHTML += '<i style="background-color:' + colours[i] + '">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i> ' + labels[i] + '<br>';
            }

            div.innerHTML += '<br><i class="circle" style="background:white"></i>Points of Interest<br>';
            div.innerHTML += '<br><i><div class="line"></div></i>Connections<br>';

            return div;
        };

        legend.addTo(map);

        geotiffLayer = L.leafletGeotiff('data/return_periods.tif', {
                    renderer: L.LeafletGeotiff.plotty({
                        clampLow: false,
                        displayMin: displayMin,
                        displayMax: displayMax,
                        colorScale: 'return-periods'
                    })
                }).addTo(map);

        L.geoJSON({
        "type": "FeatureCollection",
        "name": "long-banga-lines",
        "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
        "features": [
        { "type": "Feature", "properties": { "name": "IHAS to long banga minihydro powerhouse"}, "geometry": { "type": "LineString", "coordinates": [ [ 115.465952932912302, 3.173137970429593 ], [ 115.465091650903503, 3.172973538859537 ], [ 115.464613988048995, 3.173851672170802 ], [ 115.463012713030693, 3.174545771730782 ], [ 115.462504333101705, 3.174899269788248 ], [ 115.460892074958096, 3.176261151070904 ], [ 115.461452297992096, 3.180419932865411 ], [ 115.460293790142501, 3.182020560504434 ], [ 115.459979092602197, 3.183246446888555 ], [ 115.460293559881194, 3.184062309185021 ], [ 115.457983371064103, 3.185315659977021 ], [ 115.457876942457503, 3.187017682460609 ], [ 115.456644293964104, 3.189233109131588 ], [ 115.455398931907297, 3.189586994717204 ], [ 115.454567525020806, 3.189206066138702 ], [ 115.453765220315006, 3.187868961729459 ], [ 115.452277980098401, 3.187156181815858 ], [ 115.451217298372896, 3.185311216943588 ], [ 115.448435635310602, 3.186902770829295 ], [ 115.446349405803801, 3.188890148191195 ], [ 115.443536877857596, 3.190623800501432 ], [ 115.442784736366306, 3.191312798499571 ], [ 115.442285915265302, 3.191078494764384 ], [ 115.441973750082994, 3.190595924061408 ], [ 115.441556964046498, 3.190412397799968 ], [ 115.440742156562806, 3.190365253986554 ], [ 115.440296332586897, 3.190773458847151 ], [ 115.439872202942297, 3.190786717799616 ], [ 115.439160700076002, 3.190622800391111 ], [ 115.438470406535501, 3.190545739838081 ], [ 115.437820056946407, 3.190824677570083 ], [ 115.437237382967893, 3.19122154471459 ], [ 115.436549178984905, 3.191463388575931 ], [ 115.433752830534701, 3.195836250360027 ], [ 115.433259862038, 3.196862831014919 ], [ 115.433003033764706, 3.197140628443365 ], [ 115.431762154935498, 3.197489856002567 ], [ 115.431109493380902, 3.197951141659092 ], [ 115.429860681823499, 3.198693702355395 ], [ 115.429356962691202, 3.198783582254142 ], [ 115.429288459897705, 3.198805967130463 ], [ 115.427880496676707, 3.200527747242543 ], [ 115.427534374017497, 3.201032161243095 ], [ 115.427044007993302, 3.201911028364298 ], [ 115.426321935710604, 3.202036084423804 ], [ 115.425665291303403, 3.203053743065156 ], [ 115.425688031746105, 3.203121568313633 ], [ 115.425437793174595, 3.203505965304357 ], [ 115.424441517250798, 3.203768020805101 ], [ 115.423810347598902, 3.203602261098063 ], [ 115.423156891382405, 3.20316840338959 ], [ 115.422570578063301, 3.202805085404055 ], [ 115.422265418217407, 3.203108863792063 ], [ 115.422279495963295, 3.203637517060596 ], [ 115.421536966224494, 3.204426004449741 ], [ 115.420382579163103, 3.204294782986106 ], [ 115.420245696559306, 3.204340914085243 ], [ 115.419177982215501, 3.204751599748211 ], [ 115.418821933099906, 3.205198721333041 ], [ 115.4189767278679, 3.205548088886669 ], [ 115.419341762415698, 3.206099762947911 ], [ 115.419050628940397, 3.206673138330072 ], [ 115.418722131917804, 3.20764029529591 ], [ 115.418928601563906, 3.207899463986085 ], [ 115.419688207318003, 3.208630291064613 ], [ 115.419843308591993, 3.209046420481132 ], [ 115.419762700079204, 3.209710486845649 ], [ 115.419921273038, 3.210127582293324 ], [ 115.420261188989301, 3.211086111500742 ], [ 115.420091481898396, 3.211970866144375 ], [ 115.419733349878399, 3.212563452998131 ], [ 115.419851956566802, 3.214032744889454 ], [ 115.419716222892703, 3.214406981032505 ], [ 115.419486386042607, 3.214610592122096 ], [ 115.4188207309505, 3.214433337738441 ], [ 115.418360421626701, 3.214211830956698 ], [ 115.417855646059095, 3.214205057183251 ], [ 115.417233888363199, 3.214071649797787 ], [ 115.416285441668194, 3.214378919821299 ], [ 115.415463316448907, 3.214676631335431 ], [ 115.415620969100502, 3.215628175595783 ], [ 115.416454727693903, 3.216160432083099 ], [ 115.416816713960003, 3.217418859210568 ], [ 115.416085308954393, 3.218231489691354 ], [ 115.415610700634303, 3.218550690106967 ], [ 115.414847018178094, 3.219461575322871 ], [ 115.414267153604598, 3.219862615787909 ], [ 115.413491170798196, 3.221564067678115 ], [ 115.412783533594506, 3.221975260341243 ], [ 115.412068493883396, 3.221927218825372 ], [ 115.410982665915398, 3.22254261374313 ], [ 115.410660796689697, 3.222374323898253 ], [ 115.410052068269295, 3.222769556143852 ], [ 115.410034761273295, 3.22439183698357 ], [ 115.409423824222202, 3.224840246491529 ], [ 115.409506217330303, 3.225560398455745 ], [ 115.409493008878997, 3.226144432070497 ], [ 115.408868312640493, 3.226456840494938 ], [ 115.4087706902544, 3.226671501856724 ], [ 115.408867894634895, 3.227135854190398 ], [ 115.408696524013493, 3.227449014550667 ], [ 115.408287485760894, 3.228116586307518 ], [ 115.407842607321101, 3.229178972598346 ], [ 115.406632729343599, 3.22973536050245 ], [ 115.406053998016802, 3.230584445910442 ] ] } },
        { "type": "Feature", "properties": { "name": "Main road to long banga minihydro intake"}, "geometry": { "type": "LineString", "coordinates": [ [ 115.478517111561302, 3.180060492608024 ], [ 115.478510235843899, 3.18016860621618 ], [ 115.478328983216201, 3.181030785482038 ], [ 115.477383611061896, 3.181490102609594 ], [ 115.476184272860095, 3.180516115636312 ], [ 115.475167306944797, 3.180425793354331 ], [ 115.4742603620533, 3.180223529505381 ], [ 115.472508930031495, 3.179363283655386 ], [ 115.471403268632997, 3.179730741851707 ], [ 115.470788371265201, 3.180195525747267 ], [ 115.470378596819799, 3.18100536938633 ], [ 115.471572199308994, 3.184379409746178 ], [ 115.4716033298822, 3.184487952379358 ], [ 115.471539733766605, 3.185090973352537 ], [ 115.4714992673794, 3.185195435652364 ], [ 115.471091698833803, 3.188824179421929 ], [ 115.472519573617703, 3.191019234860306 ], [ 115.4730830802974, 3.192381271743318 ], [ 115.473059932311202, 3.193470490304926 ], [ 115.471907984176198, 3.192924206949451 ], [ 115.470977426934397, 3.19258217949103 ], [ 115.4700578209507, 3.194300928345568 ], [ 115.467655337576602, 3.194218923022337 ], [ 115.465503296059595, 3.195359145438005 ], [ 115.464435699564106, 3.196389683470518 ], [ 115.462049090483106, 3.196829449981461 ], [ 115.461193134357202, 3.198381275110359 ], [ 115.460138524956506, 3.198085336857491 ], [ 115.458993610000206, 3.198036702830747 ], [ 115.457742980546598, 3.197044935053639 ], [ 115.457636247676405, 3.197143910526315 ], [ 115.456592596055899, 3.197460991846573 ], [ 115.454287336465498, 3.194670935215529 ], [ 115.452750925592099, 3.19405911738173 ], [ 115.450748027634404, 3.192320995593068 ], [ 115.449945898163804, 3.191039536628524 ], [ 115.450226698724705, 3.18917169137375 ], [ 115.450473050773795, 3.187130090433669 ], [ 115.450437356123899, 3.186423771236684 ], [ 115.450064367136605, 3.186776117429413 ], [ 115.449582269398206, 3.188080898661629 ], [ 115.448673510593196, 3.188407478054303 ], [ 115.447747147534102, 3.18855033906507 ], [ 115.446848552638997, 3.190490677204829 ], [ 115.444672948424, 3.190731901812888 ], [ 115.443711416677203, 3.190767189976102 ], [ 115.442710884722302, 3.191313440957826 ] ] } }
        ]
        }
        , {
            color: 'black', weight: 1,
            onEachFeature: function (feature, layer) {
                layer.bindPopup(feature.properties.name);
            }
        }
    ).addTo(map);

        L.geoJSON({
        "type": "FeatureCollection",
        "name": "long-banga-points",
        "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
        "features": [
        { "type": "Feature", "properties": { "name": "Long Banga Minihydro Intake"}, "geometry": { "type": "Point", "coordinates": [ 115.478502632335704, 3.179922893543385 ] } },
        { "type": "Feature", "properties": { "name": "Long Banga Minihydro Powerhouse"}, "geometry": { "type": "Point", "coordinates": [ 115.465991032136898, 3.173099078271319 ] } },
        { "type": "Feature", "properties": { "name": "IHAS Site 1"}, "geometry": { "type": "Point", "coordinates": [ 115.405865881082903, 3.231110038701925 ] } }
        ]
        }
        , {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 4,
                    fillColor: "#ffffff",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });},
            onEachFeature: function (feature, layer) {
                layer.bindPopup(feature.properties.name);
            }
        }
    ).addTo(map);


        return {
            updateOpacity: function (opacity) {geotiffLayer.setOpacity(opacity)}
        }
    })

    .controller('RunController', function(MapService, $scope){

        this.updateOpacity = function () {
            MapService.updateOpacity(this.opacity)
        }

        this.opacity = 0.5
        this.updateOpacity()


    });

